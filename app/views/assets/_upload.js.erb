<% session_key_name = Rails.application.config.session_options[:key] %>
$(function() {
	$("#uploader").pluploadQueue({
		// General settings
		runtimes : 'html5,gears,flash,silverlight,browserplus',
		url: uploadURL,
		max_file_size : '10mb',
		multiple_queues: true,
		// Resize images on clientside if we can

	    multipart: true,
	    multipart_params: {
	      '_http_accept': 'application/javascript',
	      'authenticity_token' : '<%= form_authenticity_token %>',
	      '<%= session_key_name %>' : encodeURIComponent('<%= u cookies[session_key_name] %>')
	    },
		// Specify what files to browse for
		filters : [
			{title : "Image files", extensions : "jpg,gif,png"},
			{title : "Zip files", extensions : "zip"}
		],

		// Flash settings
		flash_swf_url : '/javascripts/plupload/plupload.flash.swf',

		// Silverlight settings
		silverlight_xap_url : '/javascripts/plupload/plupload.silverlight.xap',
		
	    init: {
	    	FileUploaded: function(up, file, info) {
	        	eval(info["response"]);
	    	}
		}		
	});

	// Client side form validation
	$('form').submit(function(e) {
        var uploader = $('#uploader').pluploadQueue();

        // Files in queue upload them first
        if (uploader.files.length > 0) {
            // When all files are uploaded submit form
            uploader.bind('StateChanged', function() {
                if (uploader.files.length === (uploader.total.uploaded + uploader.total.failed)) {
                    $('form')[0].submit();
                }
            });
                
            uploader.start();
        } else {
            alert('You must queue at least one file.');
        }

        return false;
    });
});